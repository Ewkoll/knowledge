<!DOCTYPE HTML>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>浏览器同源策略以及跨域 | Ewkoll</title>

  
  <meta name="author" content="ideath@operatorworld.com">
  

  
  <meta name="description" content="knowledge">
  

  
  
  <meta name="keywords" content="">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="浏览器同源策略以及跨域"/>

  <meta property="og:site_name" content="Ewkoll"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Ewkoll" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>


<body>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Ewkoll</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/about">关于</a></li>
      
        <li><a href="/atom.xml">订阅</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>浏览器同源策略以及跨域</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/05/26/浏览器同源策略以及跨域/" rel="bookmark">
        <time class="entry-date published" datetime="2020-05-26T07:42:02.000Z">
          2020-05-26
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="什么是浏览器同源策略"><a href="#什么是浏览器同源策略" class="headerlink" title="什么是浏览器同源策略"></a>什么是浏览器同源策略</h2><p>同源策略（Same origin policy）是一种约定，它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，则浏览器的正常功能可能都会受到影响。可以说 Web 是构建在同源策略基础之上的，浏览器只是针对同源策略的一种实现。</p>
<p>它的核心就在于它认为自任何站点装载的信赖内容是不安全的。当被浏览器半信半疑的脚本运行在沙箱时，它们应该只被允许访问来自同一站点的资源，而不是那些来自其它站点可能怀有恶意的资源。</p>
<p>简单的说：<strong>域名、协议、端口相同。</strong></p>
<p>另外，同源策略又分为以下两种：</p>
<p><strong><em>DOM 同源策略</em></strong>：禁止对不同源页面 DOM 进行操作。这里主要场景是 iframe 跨域的情况，不同域名的 iframe 是限制互相访问的。<br><strong><em>XMLHttpRequest 同源策略</em></strong>：禁止使用 XHR 对象向不同源的服务器地址发起 HTTP 请求。</p>
<h2 id="跨域的解决方法"><a href="#跨域的解决方法" class="headerlink" title="跨域的解决方法"></a>跨域的解决方法</h2><p><strong><em>JSONP方法</em></strong></p>
<p>利用 script 标签不受跨域限制，解决跨域数据请求问题。</p>
<p>核心原理就是通过Get请求把数据返回执行本地的JS脚本来完成数据交互。</p>
<p>缺点：</p>
<ul>
<li>只能是 GET 请求。</li>
<li>缺乏有效的异常捕获机制。</li>
</ul>
<p><strong><em>CORS（跨域资源共享）</em></strong></p>
<p>CORS（Cross-origin resource sharing，跨域资源共享）是一个 W3C 标准，定义了在必须访问跨域资源时，浏览器与服务器应该如何沟通。CORS 背后的基本思想，就是使用自定义的 HTTP 头部让浏览器与服务器进行沟通，从而决定请求或响应是应该成功，还是应该失败。</p>
<p>CORS 需要浏览器和服务器同时支持。目前，所有浏览器都支持该功能，<strong>IE 浏览器不能低于 IE10</strong>。</p>
<p>因此，实现 CORS 通信的关键是服务器。只要服务器实现了 CORS 接口，就可以跨源通信。</p>
<p>浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。</p>
<p>只要同时满足以下两大条件，就属于简单请求。</p>
<p>请求方法是以下三种方法之一：</p>
<ul>
<li>HEAD</li>
<li>GET</li>
<li>POST</li>
</ul>
<p>HTTP的头信息不超出以下几种字段：</p>
<ul>
<li>Accept</li>
<li>Accept-Language</li>
<li>Content-Language</li>
<li>Last-Event-ID</li>
<li>Content-Type：application/x-www-form-urlencoded、multipart/form-data、text/plain</li>
</ul>
<p><strong>凡是不同时满足上面两个条件，就属于非简单请求。</strong></p>
<p><strong>简单请求</strong></p>
<p>在请求中需要附加一个额外的 Origin 头部，其中包含请求页面的源信息（协议、域名和端口），以便服务器根据这个头部信息来决定是否给予响应。例如：Origin: <a href="http://www.baidu.com" target="_blank" rel="noopener">http://www.baidu.com</a></p>
<p>如果服务器认为这个请求可以接受，就在 Access-Control-Allow-Origin 头部中回发相同的源信息（如果是公共资源，可以回发 * ）。例如：Access-Control-Allow-Origin：<a href="http://www.baidu.com" target="_blank" rel="noopener">http://www.baidu.com</a></p>
<p>没有这个头部或者有这个头部但源信息不匹配，浏览器就会驳回请求。正常情况下，浏览器会处理请求。注意，请求和响应都不包含 cookie 信息。</p>
<p>如果需要包含 cookie 信息，ajax 请求需要设置 xhr 的属性 withCredentials 为 true，服务器需要设置响应头部 Access-Control-Allow-Credentials: true。</p>
<p><strong>非简单请求</strong></p>
<p>浏览器在发送真正的请求之前，会先发送一个 Preflight 请求给服务器，这种请求使用 OPTIONS 方法，发送下列头部：</p>
<p>Origin：跨域地址。<br>Access-Control-Request-Method: 请求自身使用的方法。<br>Access-Control-Request-Headers: （可选）自定义的头部信息，多个头部以逗号分隔。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Origin: http:&#x2F;&#x2F;www.baidu.com</span><br><span class="line">Access-Control-Request-Method: POST</span><br><span class="line">Access-Control-Request-Headers: ABC</span><br><span class="line">发送这个请求后，服务器可以决定是否允许这种类型的请求。服务器通过在响应中发送如下头部与浏览器进行沟通：</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: http:&#x2F;&#x2F;www.baidu.com</span><br><span class="line">Access-Control-Allow-Methods: GET, POST 允许的方法，多个方法以逗号分隔。</span><br><span class="line">Access-Control-Allow-Headers: ABC 允许的头部，多个方法以逗号分隔。</span><br><span class="line">Access-Control-Max-Age: 1728000 应该将这个 Preflight 请求缓存多长时间（以秒表示）。</span><br></pre></td></tr></table></figure>

<p>优点</p>
<ul>
<li>CORS 通信与同源的 AJAX 通信没有差别，代码完全一样，容易维护。</li>
<li>支持所有类型的 HTTP 请求。</li>
</ul>
<p>缺点</p>
<ul>
<li>存在兼容性问题，特别是 IE10 以下的浏览器。</li>
<li>第一次发送非简单请求时会多一次请求。</li>
</ul>
<p><strong><em>图像 Ping 跨域</em></strong></p>
<p>由于 img 标签不受浏览器同源策略的影响，允许跨域引用资源。因此可以通过 img 标签的 src 属性进行跨域，这也就是图像 Ping 跨域的基本原理。</p>
<p>直接通过下面的例子来说明图像 Ping 实现跨域的流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var img &#x3D; new Image();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 通过 onload 及 onerror 事件可以知道响应是什么时候接收到的，但是不能获取响应文本</span><br><span class="line">img.onload &#x3D; img.onerror &#x3D; function() &#123;</span><br><span class="line">    console.log(&quot;Done!&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 本质上和JSONP原理是相同</span><br><span class="line">img.src &#x3D; &#39;http:&#x2F;&#x2F;www.laixiangran.cn&#x2F;test?name&#x3D;laixiangran&#39;;</span><br></pre></td></tr></table></figure>

<p>优点<br><strong>用于实现跟踪用户点击页面或动态广告曝光次数有较大的优势。</strong></p>
<p>缺点</p>
<ul>
<li>只支持 GET 请求。</li>
<li>只能浏览器与服务器的单向通信，因为浏览器不能访问服务器的响应文本。</li>
</ul>
<p><strong><em>document.domain 跨域</em></strong><br>对于主域名相同，而子域名不同的情况，可以使用 document.domain 来跨域。</p>
<p><strong><em>window.name 跨域</em></strong><br>window 对象有个 name 属性，该属性有个特征：即在一个窗口（window）的生命周期内，窗口载入的所有的页面（不管是相同域的页面还是不同域的页面）都是共享一个 window.name 的，每个页面对 window.name 都有读写的权限，window.name 是持久存在一个窗口载入过的所有页面中的，并不会因新页面的载入而进行重置。</p>
<p><strong><em>location.hash 跨域</em></strong><br>location.hash 方式跨域，是子框架具有修改父框架 src 的 hash 值，通过这个属性进行传递数据，且更改 hash 值，页面不会刷新。但是传递的数据的字节数是有限的。</p>
<p><strong><em>postMessage 跨域</em></strong><br>window.postMessage(message，targetOrigin) 方法是 HTML5 新引进的特性，可以使用它来向其它的 window 对象发送消息，无论这个 window 对象是属于同源或不同源。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>

  
	<section id="comment" class="comment">
		<div id="gitalk-container"></div>
	</section>
	<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
	<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
	<script>
		var gitalk = new Gitalk({
			clientID: '6439928df4e0148ede52',
			clientSecret: '05309198bf54b50a56b976deba7e9cb59fcdfd64',
			repo: 'knowledge',
			owner: 'Ewkoll',
			admin: ['Ewkoll'],
			id: decodeURI(location.pathname),
			distractionFreeMode: false
		})

		gitalk.render('gitalk-container')
	</script>







    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 ideath@operatorworld.com
    
  </p>
</footer>
    
  </div>
</div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>