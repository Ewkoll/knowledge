<!DOCTYPE HTML>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Go信号处理 | Ewkoll</title>

  
  <meta name="author" content="ideath@operatorworld.com">
  

  
  <meta name="description" content="knowledge">
  

  
  
  <meta name="keywords" content="">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Go信号处理"/>

  <meta property="og:site_name" content="Ewkoll"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Ewkoll" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>


<body>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Ewkoll</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/about">关于</a></li>
      
        <li><a href="/atom.xml">订阅</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>Go信号处理</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/05/25/Go信号处理/" rel="bookmark">
        <time class="entry-date published" datetime="2020-05-25T10:10:21.000Z">
          2020-05-25
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h3 id="常见信号"><a href="#常见信号" class="headerlink" title="常见信号"></a>常见信号</h3><table>
<thead>
<tr>
<th>ID</th>
<th align="left">Linux</th>
<th align="left">Desc</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td align="left">SIGHUP</td>
<td align="left">“hangup”-重启</td>
</tr>
<tr>
<td>2</td>
<td align="left">SIGINT</td>
<td align="left">“interrupt”-中断-<code>Ctrl + C</code></td>
</tr>
<tr>
<td>3</td>
<td align="left">SIGQUIT</td>
<td align="left">“quit”-退出-<code>Ctrl + /</code></td>
</tr>
<tr>
<td>4</td>
<td align="left">SIGILL</td>
<td align="left">“illegal instruction”-非法指令，错误修改代码段</td>
</tr>
<tr>
<td>5</td>
<td align="left">SIGTRAP</td>
<td align="left">“trace/BPT trap”-陷阱-<code>断点指令或其它trap指令产生,调试用途</code></td>
</tr>
<tr>
<td>6</td>
<td align="left">SIGABRT</td>
<td align="left">“abort trap”-<code>调用 abort 函数生成的信号</code></td>
</tr>
<tr>
<td>7</td>
<td align="left">SIGEMT</td>
<td align="left">“EMT trap”-内存越界</td>
</tr>
<tr>
<td>8</td>
<td align="left">SIGFPE</td>
<td align="left">“floating point exception”-浮点数异常</td>
</tr>
<tr>
<td>9</td>
<td align="left">SIGKILL</td>
<td align="left">“killed”-杀死进程信号</td>
</tr>
<tr>
<td>10</td>
<td align="left">SIGBUS</td>
<td align="left">“bus error”-总线错误</td>
</tr>
<tr>
<td>11</td>
<td align="left">SIGSEGV</td>
<td align="left">“segmentation fault”-段错误</td>
</tr>
<tr>
<td>12</td>
<td align="left">SIGSYS</td>
<td align="left">“bad system call”-错误系统调用</td>
</tr>
<tr>
<td>13</td>
<td align="left">SIGPIPE</td>
<td align="left">“broken pipe”-管道异常</td>
</tr>
<tr>
<td>14</td>
<td align="left">SIGALRM</td>
<td align="left">“alarm clock”-时钟</td>
</tr>
<tr>
<td>15</td>
<td align="left">SIGTERM</td>
<td align="left">“terminated”-中断</td>
</tr>
</tbody></table>
<p>1) SIGHUP （HUP Hangup）<br>重启</p>
<p>2) SIGINT （INT Interrupt）<br>程序终止( interrupt )信号, 在用户键入 INTR 字符(通常是 Ctrl + C )时发出，用于通知前台进程组终止进程。</p>
<p>3) SIGQUIT （QUIT Quit）<br>由 QUIT 字符(通常是 Ctrl + / )来控制. 进程在因收到 SIGQUIT 退出时会产生 core 文件, 在这个意义上类似于一个程序错误信号。</p>
<p>4) SIGILL （ILL Illegal instruction）<br>执行了非法指令. </p>
<p>5) SIGTRAP （TRAP Trap）<br>由断点指令或其它 trap 指令产生. 由debugger 使用。</p>
<p>6) SIGABRT （ABRT Aborted）<br>调用 abort 函数生成的信号。</p>
<p>7) SIGBUS （BUS Bus error）<br>非法地址, 包括内存地址对齐( alignment )出错。比如访问一个四个字长的整数, 但其地址不是 4 的倍数。它与 SIGSEGV 的区别在于后者是由于对合法存储地址的非法访问触发的(如访问不属于自己存储空间或只读存储空间)。</p>
<p>8) SIGFPE （FPE Floating point exception）<br>在发生致命的算术运算错误时发出. 不仅包括浮点运算错误, 还包括溢出及除数为0等其它所有的算术的错误。</p>
<p>9) SIGKILL （KILL Killed）<br>用来立即结束程序的运行。本信号不能被阻塞、处理和忽略。</p>
<p>10)  SIGUSR1 （USR1 User signal 1）<br>留给用户使用</p>
<p>11) SIGSEGV （SEGV Segmentation fault）<br>试图访问未分配给自己的内存, 或试图往没有写权限的内存地址写数据。</p>
<p>12) SIGUSR2 （USR2 User signal 2）<br>留给用户使用</p>
<p>13) SIGPIPE （PIPE Broken pipe）<br>管道破裂。这个信号通常在进程间通信产生，比如采用 FIFO (管道)通信的两个进程，读管道没打开或者意外终止就往管道写，写进程会收到 SIGPIPE 信号。此外用Socket 通信的两个进程，写进程在写 Socket 的时候，读进程已经终止。</p>
<p>14) SIGALRM （ALRM Alarm clock）<br>时钟定时信号。alarm 函数使用该信号。</p>
<p>15)  SIGTERM （TERM Terminated）<br>程序结束( terminate )信号, 与 SIGKILL 不同的是该信号可以被阻塞和处理。通常用来要求程序自己正常退出，shell 命令 kill 缺省产生这个信号。如果进程终止不了，我们才会尝试 SIGKILL。</p>
<p>17) SIGCHLD （CHLD Child exited）<br>子进程结束时, 父进程会收到这个信号。</p>
<p>如果父进程没有处理这个信号，也没有等待( wait )子进程，子进程虽然终止，但是还会在内核进程表中占有表项，这时的子进程称为僵尸进程。这种情况我们应该避免(父进程或者忽略 SIGCHILD 信号，或者捕捉它，或者 wait 它派生的子进程，或者父进程先终止，这时子进程的终止自动由 init 进程来接管)。</p>
<p>18) SIGCONT （CONT Continue）<br>让一个停止( stopped )的进程继续执行。本信号不能被阻塞。</p>
<p>1)  SIGSTOP （STOP Stopped (signal)）<br>停止( stopped )进程的执行。注意它和 terminate 以及 interrupt 的区别：该进程还未结束, 只是暂停执行。本信号不能被阻塞，处理或忽略。</p>
<p>20) SIGTSTP （TSTP Stopped）<br>停止进程的运行, 但该信号可以被处理和忽略。用户键入 SUSP 字符时(通常是 Ctrl + Z )发出这个信号。</p>
<p>21) SIGTTIN （TTIN Stopped (tty input)）<br>当后台作业要从用户终端读数据时，该作业中的所有进程会收到 SIGTTIN 信号。缺省时这些进程会停止执行。</p>
<p>22) SIGTTOU （TTOU Stopped (tty output)）<br>类似于 SIGTTIN，但在写终端(或修改终端模式)时收到。</p>
<p>23) SIGURG （URG Urgent I/O condition）<br>有“紧急”数据或 out-of-band 数据到达 socket 时产生。</p>
<p>24) SIGXCPU （XCPU CPU time limit exceeded）<br>超过 CPU 时间资源限制。这个限制可以由 getrlimit/setrlimit 来读取/改变。</p>
<p>25) SIGXFSZ （XFSZ File size limit exceeded）<br>当进程企图扩大文件以至于超过文件大小资源限制。</p>
<p>26) SIGVTALRM （VTALRM Virtual timer expired）<br>虚拟时钟信号。类似于 SIGALRM，但是计算的是该进程占用的 CPU 时间。</p>
<p>27) SIGPROF （PROF Profiling timer expired）<br>类似于 SIGALRM/SIGVTALRM，但包括该进程用的 CPU 时间以及系统调用的时间。</p>
<p>28) SIGWINCH （WINCH Window size changed）<br>窗口大小改变时发出。</p>
<p>29) SIGIO （IO I/O possible）<br>文件描述符准备就绪，可以开始进行输入/输出操作。</p>
<p>30) SIGPWR （PWR Power failure）<br>Power failure</p>
<p>31) SIGSYS （SYS Bad system call）<br>非法的系统调用。</p>
<ul>
<li>程序不可捕获、阻塞或忽略的信号有：SIGKILL,SIGSTOP</li>
<li>不能恢复至默认动作的信号有：SIGILL,SIGTRAP</li>
<li>默认会导致进程流产的信号有：SIGABRT,SIGBUS,SIGFPE,SIGILL,SIGIOT,SIGQUIT,SIGSEGV,SIGTRAP,SIGXCPU,SIGXFSZ</li>
<li>默认会导致进程退出的信号有：SIGALRM,SIGHUP,SIGINT,SIGKILL,SIGPIPE,SIGPOLL,SIGPROF,SIGSYS,SIGTERM,SIGUSR1,SIGUSR2,SIGVTALRM</li>
<li>默认会导致进程停止的信号有：SIGSTOP,SIGTSTP,SIGTTIN,SIGTTOU</li>
<li>默认进程忽略的信号有：SIGCHLD,SIGPWR,SIGURG,SIGWINCH</li>
<li>此外，SIGIO 在 SVR4 是退出，在 4.3BSD 中是忽略；SIGCONT 在进程挂起时是继续，否则是忽略，不能被阻塞。</li>
</ul>
<h3 id="Go信号处理"><a href="#Go信号处理" class="headerlink" title="Go信号处理"></a>Go信号处理</h3><ul>
<li>通常应用程序需要处理以下信号：<ul>
<li>SIGHUP <ul>
<li>重启信号，一般用于进程正常的重新加载配置文件后正常启动。</li>
</ul>
</li>
<li>SIGINT<ul>
<li>拦截前台程序意外的使用<code>Ctrl + C</code>导致程序中断。</li>
</ul>
</li>
<li>SIGQUIT<ul>
<li>拦截前台程序意外的使用<code>Ctrl + /</code>导致程序中断。</li>
</ul>
</li>
<li>SIGTSTP<ul>
<li>拦截前台程序意外的使用<code>Ctrl + Z</code>导致程序暂停。</li>
</ul>
</li>
<li>SIGTERM<ul>
<li>处理程序的正常退出流程。</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"os/signal"</span></span><br><span class="line">	<span class="string">"syscall"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetStartTime</span><span class="params">()</span></span> &#123;</span><br><span class="line">	pid := os.Getpid()</span><br><span class="line">	ppid := os.Getppid()</span><br><span class="line">	fmt.Printf(<span class="string">"进程 PID: %d PPID: %d \n"</span>, pid, ppid)</span><br><span class="line"></span><br><span class="line">	ppProcess, err := os.FindProcess(ppid)</span><br><span class="line">	<span class="keyword">if</span> <span class="literal">nil</span> != err &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">"进程 PPID: %d \n"</span>, ppProcess.Pid)</span><br><span class="line"></span><br><span class="line">	goProcess, err := os.StartProcess(<span class="string">"go"</span>, []<span class="keyword">string</span>&#123;<span class="string">"version"</span>&#125;, &amp;os.ProcAttr&#123;</span><br><span class="line">		Dir: <span class="string">"/usr/local/go/bin/"</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> <span class="literal">nil</span> != err &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"PID: %d\n"</span>, goProcess.Pid)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//err = ppProcess.Kill()</span></span><br><span class="line">	<span class="comment">//if nil != err &#123;</span></span><br><span class="line">	<span class="comment">//	fmt.Println(err)</span></span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> App <span class="keyword">interface</span> &#123;</span><br><span class="line">	Start()</span><br><span class="line">	Stop()</span><br><span class="line">	ReStart()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CommonApp <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *CommonApp)</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"Start"</span>)</span><br><span class="line">	GetStartTime()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *CommonApp)</span> <span class="title">Stop</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"Stop"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(app *CommonApp)</span> <span class="title">ReStart</span><span class="params">()</span></span> &#123;</span><br><span class="line">	app.Stop()</span><br><span class="line">	app.Start()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	comonApp := CommonApp&#123;&#125;</span><br><span class="line">	<span class="keyword">var</span> app App = &amp;comonApp</span><br><span class="line">	Enter(app)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Enter</span><span class="params">(app App)</span></span> &#123;</span><br><span class="line">	app.Start()</span><br><span class="line">	exit := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	reload := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">go</span> ProcSignal(exit, reload)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-reload:</span><br><span class="line">			app.ReStart()</span><br><span class="line">		<span class="keyword">case</span> &lt;-exit:</span><br><span class="line">			app.Stop()</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ProcSignal</span><span class="params">(exit <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, reload <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	signals := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal)</span><br><span class="line">	signal.Notify(signals, syscall.SIGTSTP, syscall.SIGQUIT, syscall.SIGINT, syscall.SIGUSR1, syscall.SIGUSR2, syscall.SIGHUP, syscall.SIGTERM)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		sig := &lt;-signals</span><br><span class="line">		fmt.Println(<span class="string">"接收信号:"</span>, sig)</span><br><span class="line">		<span class="keyword">if</span> sig == syscall.SIGTERM &#123;</span><br><span class="line">			fmt.Println(<span class="string">"终止程序"</span>)</span><br><span class="line">			signal.Stop(signals)</span><br><span class="line">			exit &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> sig &#123;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			fmt.Printf(<span class="string">"接收信号=%v\n"</span>, sig)</span><br><span class="line">		<span class="keyword">case</span> syscall.SIGINT:</span><br><span class="line">			fmt.Println(<span class="string">"中断信号"</span>)</span><br><span class="line">		<span class="keyword">case</span> syscall.SIGTSTP:</span><br><span class="line">			fmt.Println(<span class="string">"暂停信号"</span>)</span><br><span class="line">		<span class="keyword">case</span> syscall.SIGQUIT:</span><br><span class="line">			fmt.Println(<span class="string">"退出信号"</span>)</span><br><span class="line">		<span class="keyword">case</span> syscall.SIGHUP:</span><br><span class="line">			fmt.Println(<span class="string">"重启信号"</span>)</span><br><span class="line">			reload &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">		<span class="keyword">case</span> syscall.SIGUSR1:</span><br><span class="line">			fmt.Println(<span class="string">"用户信号-1"</span>)</span><br><span class="line">		<span class="keyword">case</span> syscall.SIGUSR2:</span><br><span class="line">			fmt.Println(<span class="string">"用户信号-2"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>

  
	<section id="comment" class="comment">
		<div id="gitalk-container"></div>
	</section>
	<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
	<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
	<script>
		var gitalk = new Gitalk({
			clientID: '6439928df4e0148ede52',
			clientSecret: '05309198bf54b50a56b976deba7e9cb59fcdfd64',
			repo: 'knowledge',
			owner: 'Ewkoll',
			admin: ['Ewkoll'],
			id: decodeURI(location.pathname),
			distractionFreeMode: false
		})

		gitalk.render('gitalk-container')
	</script>







    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 ideath@operatorworld.com
    
  </p>
</footer>
    
  </div>
</div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>